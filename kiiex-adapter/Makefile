# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Service Metadata
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SERVICE        := kiiex-adapter
PKG            := github.com/Checker-Finance/adapters
BIN            := ./bin/$(SERVICE)
MAIN           := ./$(SERVICE)/cmd/$(SERVICE)/main.go

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âš™ï¸ Build Settings
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GO             := go
GOFLAGS        := -trimpath
LDFLAGS        := -s -w -X '$(PKG)/version.BuildTime=$(shell date -u +"%Y-%m-%dT%H:%M:%SZ")'

# Docker / AWS
ECR_REPO       := 730335471935.dkr.ecr.us-east-2.amazonaws.com
TAG            := $(shell cat VERSION 2>/dev/null || echo latest)
IMAGE          := $(ECR_REPO)/$(SERVICE):$(TAG)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ§© Default Target
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.PHONY: all
all: build

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ§° Build & Run (run from repo root)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.PHONY: build
build:
	@echo "Building $(SERVICE)..."
	@cd .. && $(GO) build $(GOFLAGS) -ldflags "$(LDFLAGS)" -o $(SERVICE)/$(BIN) $(MAIN)

.PHONY: run
run:
	@echo "Running $(SERVICE)..."
	@cd .. && $(GO) run $(MAIN)

.PHONY: clean
clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	@rm -rf bin coverage.out

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ§ª Test, Benchmark, Lint
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.PHONY: test
test:
	@echo "ðŸ§ª Running unit tests..."
	@cd .. && $(GO) test ./$(SERVICE)/... -count=1 -race -v

.PHONY: bench
bench:
	@echo "âš¡ Running benchmarks..."
	@cd .. && $(GO) test -bench=. -benchmem ./$(SERVICE)/...

.PHONY: cover
cover:
	@echo "ðŸ“Š Running coverage..."
	@cd .. && $(GO) test ./$(SERVICE)/... -coverprofile=$(SERVICE)/coverage.out
	@$(GO) tool cover -func=$(SERVICE)/coverage.out

.PHONY: fmt
fmt:
	@echo "âœ¨ Formatting code..."
	@cd .. && $(GO) fmt ./$(SERVICE)/...

.PHONY: lint
lint:
	@echo "ðŸ”Ž Linting..."
	@cd .. && golangci-lint run --timeout=5m

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ³ Docker Build & Push
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.PHONY: docker-build
docker-build:
	@echo "ðŸ³ Building Docker image $(IMAGE)..."
	@docker build -f $(SERVICE)/Dockerfile -t $(IMAGE) ..

.PHONY: docker-push
docker-push: docker-build
	@echo "ðŸš¢ Pushing image to ECR..."
	@aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin $(ECR_REPO)
	@docker push $(IMAGE)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ” Utility
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.PHONY: version
version:
	@echo "ðŸ“¦ Version: $(TAG)"

.PHONY: help
help:
	@echo "Checker $(SERVICE) â€” available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## ' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-18s\033[0m %s\n", $$1, $$2}'

## ---------------------------
## Version bump
## ---------------------------

bump-patch:
	@old=$$(cat VERSION); \
	new=$$(echo $$old | awk -F. '{ $$3++; print $$1"."$$2"."$$3 }'); \
	echo $$new > VERSION; \
	echo "Bumped patch version: $$old â†’ $$new"

bump-minor:
	@old=$$(cat VERSION); \
	new=$$(echo $$old | awk -F. '{ $$2++; $$3=0; print $$1"."$$2"."$$3 }'); \
	echo $$new > VERSION; \
	echo "Bumped minor version: $$old â†’ $$new"

bump-major:
	@old=$$(cat VERSION); \
	new=$$(echo $$old | awk -F. '{ $$1++; $$2=0; $$3=0; print $$1"."$$2"."$$3 }'); \
	echo $$new > VERSION; \
	echo "Bumped major version: $$old â†’ $$new"
